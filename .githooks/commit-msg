#!/bin/sh
#
# Git hook to validate conventional commit messages
# Install: git config core.hooksPath .githooks
#
# Format: <type>(<scope>): <description>
#         [optional body]
#         [optional footer]

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Skip merge commits
if echo "$commit_msg" | grep -qE "^Merge "; then
    exit 0
fi

# Conventional commit pattern
# Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert
pattern="^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\([a-z0-9_-]+\))?(!)?: .{1,}"

if ! echo "$commit_msg" | head -1 | grep -qE "$pattern"; then
    echo ""
    echo "ERROR: Commit message does not follow Conventional Commits format."
    echo ""
    echo "Expected: <type>(<scope>): <description>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert"
    echo ""
    echo "Examples:"
    echo "  feat(tui): add filtering by tool name"
    echo "  fix(parser): handle empty SSE delta"
    echo "  docs: update contributing guide"
    echo "  refactor!: restructure event system"
    echo ""
    echo "Your message was:"
    echo "  $(head -1 "$commit_msg_file")"
    echo ""
    exit 1
fi

# Warn if description is too long (soft limit)
first_line=$(echo "$commit_msg" | head -1)
if [ ${#first_line} -gt 72 ]; then
    echo "WARNING: First line is ${#first_line} chars (recommended: â‰¤72)"
fi
